
# {{ project_name }}

**Template generated from microscopy-ai-copier-template.**

This repository standardizes AI image analysis projects for microscopy with:

- **Pixi** for multi-environment management and tasks (cellpose3 / cellpose4 / micro-sam; optional CUDA)
- **DVC** for large data and model versioning (local disk or **Allas S3**)
- A tight iteration loop: test → annotate → train → evaluate → repeat
- Text-first configs & manifests; binaries kept out of Git

## Quickstart

> Prereqs: Install **pixi** and **git**. If using DVC+S3 (Allas), have credentials ready.

```bash
# clone as usual
git clone <THIS-REPO-URL> {{ project_slug }}
cd {{ project_slug }}

# create or use the desired environment (CPU shown)
pixi install -e cellpose4-cpu
pixi run -e cellpose4-cpu check

# pull data pointers (if using DVC)
pixi run dvc:pull

# test baseline on test split
pixi run -e cellpose4-cpu test --split data/splits/v1/test.csv

# open napari with preloaded project context
pixi run -e microsam-cpu browse-test
```

> To use **CUDA**, choose a `-cuda` environment, e.g. `cellpose4-cuda`.

## Project layout
```
{{ project_slug }}/
├─ pixi.toml
├─ .gitignore
├─ .gitattributes
├─ .env.example
├─ README.md
├─ configs/
│  ├─ project.yaml
│  ├─ data.yaml
│  ├─ train.cellpose3.yaml
│  ├─ train.cellpose4.yaml
│  └─ train.microsam.yaml
├─ data/
│  ├─ manifest.csv
│  ├─ splits/v1/{train,val,test}.csv
│  └─ local/            # optional cache (gitignored)
├─ annotations/
│  ├─ labels/           # masks (gitignored)
│  └─ meta/labels.csv   # text manifest
├─ models/              # tracked by DVC (gitignored)
├─ scripts/
│  ├─ prepare_data.py
│  ├─ test_model.py
│  ├─ train_cellpose.py
│  ├─ train_microsam.py
│  ├─ evaluate.py
│  ├─ fetch_pretrained.py
│  ├─ register_model.py
│  ├─ plate_sampler_wrapper.py
│  └─ utils/io.py
├─ jobs/
│  ├─ local.ps1
│  └─ puhti.slurm
├─ outputs/
│  ├─ runs/
│  └─ reports/
└─ dvc.yaml (if use_dvc)
```

## Storage backends

- **Local**: use `file://` URIs and `data/local/` as a cache.
- **Allas (S3)**: configure your bucket & endpoint; DVC will push/pull data & models there. See **DVC & Allas** below.

## Environments

We provide **separate Pixi environments** to isolate dependencies and even Python versions:

- `cellpose3-cpu` / `cellpose3-cuda` → Cellpose v3 stack
- `cellpose4-cpu` / `cellpose4-cuda` → Cellpose v4 (+SAM) stack
- `microsam-cpu` / `microsam-cuda` → micro-SAM + napari for annotation

Use them via:

```bash
pixi shell -e cellpose4-cuda
# or run tasks without entering the shell
pixi run -e microsam-cpu browse
```

## Napari launcher

The **browse** tasks export `PLATE_PROJECT_ROOT` so your
**napari-plate-navigator** plugin can look up roots via `configs/data.yaml` automatically.

## DVC & Allas

1. Copy `.env.example` to `.env` and fill S3 credentials.
2. If you selected S3 in copier answers, run:

```bash
# set up DVC remote (first time only)
pixi run dvc:init
# push data & models later with
pixi run dvc:push
```

See `docs/storage.md` for more.

## Typical formats
Supports `.tiff/.tif` and `.czi`. Add more via `scripts/utils/io.py`.

---
Generated by {{ author_name or 'copier' }} on {{ '{{ now | strftime("%Y-%m-%d") }}' }}.
